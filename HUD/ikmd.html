<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>WebAR Chroma Key Final</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
      #start-btn {
        position: absolute; bottom: 30px; left: 50%; transform: translate(-50%, 0);
        padding: 15px 40px; background: #00AA00; color: white; font-weight: bold;
        border: 2px solid white; font-size: 20px; border-radius: 30px; z-index: 9999; cursor: pointer;
      }
    </style>
  </head>
  
  <body style="margin: 0; overflow: hidden;">
    
    <div id="start-btn">TAP TO START</div>

    <script>
      AFRAME.registerShader('chromakey', {
        schema: {
          src: {type: 'map'},
          color: {default: {x: 0.1, y: 0.9, z: 0.2}, type: 'vec3'}, // 抜く色（RGB 0~1）
          threshold: {default: 0.4, type: 'number'} // しきい値
        },
        init: function (data) {
          const videoTexture = new THREE.VideoTexture(data.src);
          videoTexture.format = THREE.RGBAFormat;
          videoTexture.minFilter = THREE.LinearFilter; // テクスチャ補間設定
          this.material = new THREE.ShaderMaterial({
            uniforms: {
              texture: { value: videoTexture },
              color: { value: data.color },
              threshold: { value: data.threshold }
            },
            vertexShader: `
              varying vec2 vUv;
              void main() { vUv = uv; gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 ); }
            `,
            fragmentShader: `
              uniform sampler2D texture; uniform vec3 color; uniform float threshold; varying vec2 vUv;
              void main() {
                vec4 texel = texture2D( texture, vUv );
                float dist = distance(texel.rgb, color);
                if (dist < threshold) { discard; } // 緑に近い色は描画しない
                gl_FragColor = texel;
              }
            `,
            transparent: true
          });
        }
      });
    </script>

    <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;" vr-mode-ui="enabled: false">
      <a-assets>
        <video id="my-video" 
               src="./ikmd.mp4" 
               crossorigin="anonymous" 
               playsinline webkit-playsinline loop muted>
        </video>
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false">
        <a-entity 
          geometry="primitive: plane; width: 1.6; height: 0.9" 
          position="0 0 -2"
          material="shader: chromakey; src: #my-video; color: 0.1 0.9 0.2; threshold: 0.6">
        </a-entity>
      </a-camera>
    </a-scene>

    <script>
      document.querySelector('#start-btn').addEventListener('click', function (e) {
        var v = document.querySelector('#my-video');
        v.play().then(() => {
          e.target.style.display = 'none';
        }).catch((err) => {
          alert("再生エラー: 動画の形式を確認してください\n" + err);
        });
      });
    </script>
  </body>
</html>
